<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Circle Game</title>
    <style>
        .square {
            width: 40px;
            height: 40px;
            float: left;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .green-circle, .red-circle, .orange-circle, .black-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }
        .green-circle { background: green; }
        .red-circle { background: red; }
        .orange-circle { background: orange; }
        .black-circle { background: black; }
        #controls { clear: both; margin-top: 20px; }
        button { margin: 5px; }
    </style>
</head>
<body>

<div id="game-board"></div>

<div id="controls">
    <button id="RESTART">RESTART</button>
    <button id="UP">UP</button>
    <button id="DOWN">DOWN</button>
    <button id="LEFT">LEFT</button>
    <button id="RIGHT">RIGHT</button>
</div>

<div id="score">Score: 0</div>
<div id="end-of-game-message"></div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    createInitialBoard();
    eventHandlers();
});

function eventHandlers() {
    document.getElementById("RESTART").addEventListener("click", function (e) {
        e.preventDefault();
        startGame("RELOAD");
    });
    document.getElementById("UP").addEventListener("click", function (e) {
        e.preventDefault();
        console.log("UP clicked");
        startGame("UP");
    });
    document.getElementById("DOWN").addEventListener("click", function (e) {
        e.preventDefault();
        startGame("DOWN");
    });
    document.getElementById("LEFT").addEventListener("click", function (e) {
        e.preventDefault();
        startGame("LEFT");
    });
    document.getElementById("RIGHT").addEventListener("click", function (e) {
        e.preventDefault();
        startGame("RIGHT");
    });

    // Prevent pinch-zoom on mobile
    document.addEventListener('gestureend', function (e) {
        e.preventDefault();
        document.body.style.zoom = 0.99;
    });
}

// === Game state and logic ===

var board = new Array(64).fill("empty");
board[0] = "green";
board[63] = "orange";
board[56] = "red";

var gameInProgress = false;
var humanDirection = "NO MOVEMENT";
var circleObjects = [
    { colour: 'green', squareNum: 0 },    // human
    { colour: 'orange', squareNum: 63 },  // target
    { colour: 'red', squareNum: 56 }      // enemy
];
var millisecondsElapsed = 0;
var score = 0;
var numberOfComputerOpponents = 1;
var intervalSetter;

function createInitialBoard() {
    const boardHTML = board.map(cell => {
        if (cell === "green") return '<div class="square"><div class="green-circle"></div></div>';
        if (cell === "red") return '<div class="square"><div class="red-circle"></div></div>';
        if (cell === "orange") return '<div class="square"><div class="orange-circle"></div></div>';
        return '<div class="square"></div>';
    }).join("");
    document.getElementById("game-board").innerHTML = boardHTML;
}

function updateBoardView() {
    var boardDivs = document.getElementsByClassName("square");
    for (let i = 0; i < board.length; i++) {
        if (board[i] === "green") boardDivs[i].innerHTML = '<div class="green-circle"></div>';
        else if (board[i] === "red") boardDivs[i].innerHTML = '<div class="red-circle"></div>';
        else if (board[i] === "orange") boardDivs[i].innerHTML = '<div class="orange-circle"></div>';
        else if (board[i] === "black") boardDivs[i].innerHTML = '<div class="black-circle"></div>';
        else boardDivs[i].innerHTML = '';
    }
}

function startGame(userChoice) {
    if (userChoice === "RELOAD") return location.reload();
    humanDirection = userChoice;
    gameInProgress = true;
    clearInterval(intervalSetter);
    activateIntervalSetter();
}

function activateIntervalSetter() {
    intervalSetter = setInterval(inGameActions, 240);
}

function inGameActions() {
    moveGreenCircle(humanDirection);
    makeComputerMove();
    updateBoardRepresentation();

    if (circleObjects[0].squareNum === circleObjects[1].squareNum) {
        score += 10;
        circleObjects[1].squareNum = findFreeSquare();
    }

    document.getElementById("score").textContent = "Score: " + score;

    if (isHumanEliminated()) {
        document.getElementById("end-of-game-message").textContent = "You've been eliminated. Press 'RESTART' to play again.";
        ["UP", "DOWN", "LEFT", "RIGHT"].forEach(id => document.getElementById(id).disabled = true);
        gameInProgress = false;
    }

    updateBoardRepresentation();

    if (millisecondsElapsed % 30000 === 0 && numberOfComputerOpponents < 4 && gameInProgress && millisecondsElapsed > 0) {
        let squareForNewPlayer = findFreeSquare();
        newComputerPlayer(squareForNewPlayer);
        numberOfComputerOpponents++;
        updateBoardRepresentation();
    }

    updateBoardView();
    humanDirection = "NO MOVEMENT";
    millisecondsElapsed += 240;

    if (!gameInProgress) clearInterval(intervalSetter);
}

function isHumanEliminated() {
    return getRedPlayerSquareNums().includes(circleObjects[0].squareNum);
}

function updateBoardRepresentation() {
    let human = circleObjects[0].squareNum;
    let orange = circleObjects[1].squareNum;
    let redPlayers = getRedPlayerSquareNums();
    let occupied = getAllOccupiedSquares();

    for (let i = 0; i < 64; i++) {
        if (!gameInProgress && i === human) board[i] = "black";
        else if (i === human) board[i] = "green";
        else if (i === orange) board[i] = "orange";
        else if (redPlayers.includes(i)) board[i] = "red";
        else if (!occupied.includes(i)) board[i] = "empty";
    }
}

function getAllOccupiedSquares() {
    return circleObjects.map(obj => obj.squareNum);
}

function getRedPlayerSquareNums() {
    return circleObjects.filter(obj => obj.colour === "red").map(obj => obj.squareNum);
}

function moveGreenCircle(dir) {
    let cur = circleObjects[0].squareNum;
    let row = Math.floor(cur / 8), col = cur % 8;

    switch (dir) {
        case "UP": circleObjects[0].squareNum = (row === 0) ? cur + 56 : cur - 8; break;
        case "DOWN": circleObjects[0].squareNum = (row === 7) ? cur - 56 : cur + 8; break;
        case "LEFT": circleObjects[0].squareNum = (col === 0) ? cur + 7 : cur - 1; break;
        case "RIGHT": circleObjects[0].squareNum = (col === 7) ? cur - 7 : cur + 1; break;
    }
}

function makeComputerMove() {
    for (let sprite of circleObjects) {
        if (sprite.colour !== "red") continue;
        let dir = getDirection(sprite);
        setNewSquare(sprite, dir);
        updateBoardRepresentation();
    }
}

function setNewSquare(sprite, dir) {
    let s = sprite.squareNum;
    let delta = { "UP": -8, "DOWN": 8, "LEFT": -1, "RIGHT": 1, "NO MOVEMENT": 0 }[dir];
    sprite.squareNum += delta;
}

function getDirection(sprite) {
    if (!doesValidMoveExist(sprite)) return "NO MOVEMENT";
    let directions = ["UP", "DOWN", "LEFT", "RIGHT"];
    while (true) {
        let r = Math.floor(Math.random() * 4);
        if (isProposedComputerMoveValid(sprite, r)) return directions[r];
    }
}

function isProposedComputerMoveValid(sprite, d) {
    const cur = sprite.squareNum;
    const reds = getRedPlayerSquareNums();
    const orange = circleObjects[1].squareNum;

    const isTop = cur <= 7, isBottom = cur >= 56;
    const isLeft = [0,8,16,24,32,40,48,56].includes(cur);
    const isRight = [7,15,23,31,39,47,55,63].includes(cur);

    if ((d === 0 && isTop) || (d === 1 && isBottom) || (d === 2 && isLeft) || (d === 3 && isRight)) return false;

    let target = [cur - 8, cur + 8, cur - 1, cur + 1][d];
    return !reds.includes(target) && target !== orange;
}

function doesValidMoveExist(red) {
    let i = red.squareNum;
    const isTop = i <= 7, isBottom = i >= 56;
    const isLeft = [0,8,16,24,32,40,48,56].includes(i);
    const isRight = [7,15,23,31,39,47,55,63].includes(i);

    if (!isLeft && !["red", "orange"].includes(board[i - 1])) return true;
    if (!isRight && !["red", "orange"].includes(board[i + 1])) return true;
    if (!isTop && !["red", "orange"].includes(board[i - 8])) return true;
    if (!isBottom && !["red", "orange"].includes(board[i + 8])) return true;
    return false;
}

function findFreeSquare() {
    while (true) {
        let r = Math.floor(Math.random() * 64);
        if (board[r] === "empty") return r;
    }
}

function newComputerPlayer(square) {
    circleObjects.push({ colour: 'red', squareNum: square });
}
</script>
</body>
</html>
